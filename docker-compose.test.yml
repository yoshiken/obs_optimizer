# OBS Optimizer テスト実行環境
# ホスト環境を汚さずにテストを実行するためのDocker Compose設定
#
# 使用方法:
#   全テスト実行:     docker compose -f docker-compose.test.yml run --rm test-all
#   Rustテストのみ:   docker compose -f docker-compose.test.yml run --rm test-rust
#   フロントエンドのみ: docker compose -f docker-compose.test.yml run --rm test-frontend
#   対話シェル:       docker compose -f docker-compose.test.yml run --rm test-shell

services:
  # 全テスト実行 (Rust + Frontend)
  test-all:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obs-optimizer-test-all
    volumes:
      - .:/workspace
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - pnpm-cache:/home/developer/.local/share/pnpm
    environment:
      - RUST_BACKTRACE=1
      - CARGO_TERM_COLOR=always
    working_dir: /workspace
    command: >
      bash -c "
        echo '========================================' &&
        echo '  OBS Optimizer Test Runner' &&
        echo '========================================' &&
        echo '' &&
        echo '[1/3] Installing frontend dependencies...' &&
        pnpm install --frozen-lockfile &&
        echo '' &&
        echo '[2/3] Running Rust tests...' &&
        cd src-tauri && cargo test --lib --color=always 2>&1 && cd .. &&
        echo '' &&
        echo '[3/3] Running frontend tests...' &&
        pnpm test --run &&
        echo '' &&
        echo '========================================' &&
        echo '  All tests completed successfully!' &&
        echo '========================================'
      "

  # Rustテストのみ
  test-rust:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obs-optimizer-test-rust
    volumes:
      - .:/workspace
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
    environment:
      - RUST_BACKTRACE=1
      - CARGO_TERM_COLOR=always
    working_dir: /workspace/src-tauri
    command: >
      bash -c "
        echo '========================================' &&
        echo '  Rust Backend Test Runner' &&
        echo '========================================' &&
        echo '' &&
        cargo test --lib --color=always 2>&1 &&
        echo '' &&
        echo 'Rust tests completed!'
      "

  # Rust統合テスト
  test-rust-integration:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obs-optimizer-test-rust-integration
    volumes:
      - .:/workspace
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
    environment:
      - RUST_BACKTRACE=1
      - CARGO_TERM_COLOR=always
    working_dir: /workspace/src-tauri
    command: >
      bash -c "
        echo '========================================' &&
        echo '  Rust Integration Test Runner' &&
        echo '========================================' &&
        echo '' &&
        cargo test --test '*' --color=always 2>&1 &&
        echo '' &&
        echo 'Integration tests completed!'
      "

  # フロントエンドテストのみ
  test-frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obs-optimizer-test-frontend
    volumes:
      - .:/workspace
      - pnpm-cache:/home/developer/.local/share/pnpm
    environment:
      - CI=true
    working_dir: /workspace
    command: >
      bash -c "
        echo '========================================' &&
        echo '  Frontend Test Runner' &&
        echo '========================================' &&
        echo '' &&
        pnpm install --frozen-lockfile &&
        pnpm test --run &&
        echo '' &&
        echo 'Frontend tests completed!'
      "

  # フロントエンドカバレッジ
  test-frontend-coverage:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obs-optimizer-test-frontend-coverage
    volumes:
      - .:/workspace
      - pnpm-cache:/home/developer/.local/share/pnpm
    environment:
      - CI=true
    working_dir: /workspace
    command: >
      bash -c "
        echo '========================================' &&
        echo '  Frontend Coverage Runner' &&
        echo '========================================' &&
        echo '' &&
        pnpm install --frozen-lockfile &&
        pnpm test:coverage &&
        echo '' &&
        echo 'Coverage report generated in coverage/'
      "

  # 対話シェル（デバッグ用）
  test-shell:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obs-optimizer-test-shell
    volumes:
      - .:/workspace
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - pnpm-cache:/home/developer/.local/share/pnpm
    environment:
      - RUST_BACKTRACE=1
      - CARGO_TERM_COLOR=always
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: bash

volumes:
  cargo-cache:
  cargo-git:
  pnpm-cache:
